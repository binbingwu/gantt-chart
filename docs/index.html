<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gantt Chart – Hierarchical Project Filter</title>
  <link rel="stylesheet" href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css">
  <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: Arial, sans-serif;
      background-color: #fafafa;
      overflow: hidden;
    }
    #controls {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 10px 15px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
    }
    #zoomValue {
      width: 60px;
      text-align: right;
      font-family: monospace;
    }
    #gantt_container {
      width: 100%;
      height: calc(100vh - 60px);
      overflow: auto;
      position: relative;
    }
    #gantt_wrapper {
      transform-origin: top left;
      transition: transform 0.1s ease-out;
      display: inline-block;
    }
    #gantt_here {
      width: 1200px;
      height: 800px;
    }
    #filterInfo {
      font-weight: bold;
    }
  </style>
</head>
<body>

  <div id="controls">
    <div>
      <label>Zoom:</label>
      <input type="range" id="zoomSlider" min="0.5" max="2" step="0.01" value="0.6">
      <span id="zoomValue">0.60×</span>
    </div>
    <div id="filterInfo">Showing: All Projects</div>
  </div>

  <div id="gantt_container">
    <div id="gantt_wrapper">
      <div id="gantt_here"></div>
    </div>
  </div>

  <script>
    gantt.config.xml_date = "%Y-%m-%d";

    // ✅ 新版尺度配置：主刻度为年，子刻度为月
    gantt.config.scales = [
      {
      unit: "year",
      step: 1,
      format: function(date){
        const year = date.getFullYear();
        const month = date.getMonth();
        const quarter = Math.floor(month / 3) + 1;
        return `${year}`;  // 保留你的原逻辑：仅显示年份
        }
      },
      {
      unit: "month",
      step: 1,
      format: "%M"  // 月份显示
      }
    ];

    gantt.config.min_column_width = 100;
    gantt.config.scale_height = 60;
    gantt.config.grid_width = 80;
    gantt.config.autosize = "xy";
    gantt.config.show_progress = true;

    gantt.config.columns = [
      { name: "text", label: "Task Name", tree: true, width: 200 },
      { name: "duration", label: "Duration", align: "center" }
    ];

    gantt.templates.task_text = (start, end, task) =>
      `${task.text} (${Math.round((task.progress || 0) * 100)}%)`;

    gantt.init("gantt_here");
   
    let VISIBLE_IDS = null;
    gantt.attachEvent("onBeforeTaskDisplay", id => !VISIBLE_IDS || VISIBLE_IDS.has(id));

    // -----------------------
    // 读取URL参数
    // -----------------------
    const params = new URLSearchParams(window.location.search);
    const zoomParam = parseFloat(params.get("zoom")) || 0.6; // 默认缩放0.6
    const projectParam = params.get("project");

    // -----------------------
    // 数据加载
    // -----------------------
    fetch("./data.json?v=" + Date.now())
      .then(r => r.json())
      .then(data => {
        gantt.parse(data);
        applyProjectFilterFromURL(data.data);
        setInitialZoom(zoomParam); // ✅ 设置初始缩放
      })
      .catch(() => gantt.message({ text: "Cannot load data.json", type: "error" }));

    // -----------------------
    // 根据 URL 参数过滤
    // -----------------------
    function applyProjectFilterFromURL(tasks) {
      const filterInfo = document.getElementById("filterInfo");
      if (!projectParam || projectParam === "all") {
        VISIBLE_IDS = null;
        filterInfo.textContent = "Showing: All Projects";
        gantt.eachTask(t => gantt.open(t.id));
        gantt.config.start_date = null;
        gantt.config.end_date = null;
        gantt.render();
        return;
      }

      const decoded = decodeURIComponent(projectParam).trim().toLowerCase();
      const selectedTask = tasks.find(
        t => t.id.toLowerCase() === decoded || t.text.trim().toLowerCase() === decoded
      );

      if (!selectedTask) {
        gantt.message({ text: `Task "${decodeURIComponent(projectParam)}" not found`, type: "warning" });
        filterInfo.textContent = "Not found";
        return;
      }

      filterInfo.textContent = `Showing: ${selectedTask.text}`;
      const visible = new Set();

      // ✅ 收集选中任务的所有子孙
      function collectDescendants(id) {
        visible.add(id);
        gantt.getChildren(id).forEach(child => collectDescendants(child));
      }
      collectDescendants(selectedTask.id);

      // ✅ 向上追溯父链并添加兄弟
      let parent = selectedTask.parent;
      let parentChain = [];
      while (parent) {
        parentChain.push(parent);
        parent = gantt.getTask(parent).parent;
      }

      parentChain.forEach(pid => {
        visible.add(pid);
        gantt.getChildren(pid).forEach(sibling => visible.add(sibling));
      });

      VISIBLE_IDS = visible;

      // 展开逻辑
      gantt.eachTask(t => gantt.close(t.id));
      parentChain.forEach(pid => gantt.open(pid));
      expandAllChildren(selectedTask.id);

      gantt.showTask(selectedTask.id);
      adjustTimeScaleToSelection(selectedTask.id);
      gantt.render();
    }

    // -----------------------
    // 自动时间范围调整
    // -----------------------
    function adjustTimeScaleToSelection(taskId) {
      let targetTask = gantt.getTask(taskId);
      let baseId = taskId;

      // 如果有父项，则使用最高一层父项
      if (targetTask.parent) {
        let p = targetTask.parent;
        while (p) {
          baseId = p;
          const pt = gantt.getTask(p);
          p = pt ? pt.parent : null;
        }
      }

      const tasks = [];
      collectVisibleTasks(baseId, tasks);
      if (tasks.length === 0) return;

      const minDate = new Date(Math.min(...tasks.map(t => new Date(t.start_date))));
      const maxDate = new Date(Math.max(...tasks.map(t => new Date(t.end_date))));

      minDate.setDate(minDate.getDate() - 10);
      maxDate.setDate(maxDate.getDate() + 10);

      gantt.config.start_date = minDate;
      gantt.config.end_date = maxDate;
    }

    function collectVisibleTasks(id, list) {
      const t = gantt.getTask(id);
      if (!t) return;
      list.push(t);
      gantt.getChildren(id).forEach(child => collectVisibleTasks(child, list));
    }

    function expandAllChildren(id) {
      gantt.open(id);
      gantt.getChildren(id).forEach(child => expandAllChildren(child));
    }

    // -----------------------
    // 缩放控制
    // -----------------------
    const zoomSlider = document.getElementById("zoomSlider");
    const zoomValueLabel = document.getElementById("zoomValue");
    const ganttWrapper = document.getElementById("gantt_wrapper");

    zoomSlider.addEventListener("input", () => {
      const scale = parseFloat(zoomSlider.value);
      ganttWrapper.style.transform = `scale(${scale})`;
      zoomValueLabel.textContent = scale.toFixed(2) + "×";
    });

    // ✅ 初始缩放函数
    function setInitialZoom(scale) {
      zoomSlider.value = scale;
      ganttWrapper.style.transform = `scale(${scale})`;
      zoomValueLabel.textContent = scale.toFixed(2) + "×";
    }
  </script>
</body>
</html>
